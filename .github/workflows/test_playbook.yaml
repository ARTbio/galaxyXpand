name: Test Playbook

on:
  push:
    branches-ignore:
      - readthedocs
      - main
env:
  # Global environment variables for the entire job
  BIOBLEND_GALAXY_URL: "http://127.0.0.1:80"
  BIOBLEND_TEST_JOB_TIMEOUT: "240"
  GALAXY_USER: tooladmin@galaxy.org
  # NOTE: The password is intentionally in plaintext for this demo version.
  GALAXY_USER_PASSWD: artbio2024

jobs:
  Ubuntu_24-04:
    name: GalaxyXpand on Ubuntu 24.04
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install minimal Python/Ansible (with venv)
      run: |
        # Configure dpkg to ignore man and doc
        echo "path-exclude /usr/share/doc/*" | sudo tee /etc/dpkg/dpkg.cfg.d/01-nodoc
        echo "path-exclude /usr/share/man/*" | sudo tee -a /etc/dpkg/dpkg.cfg.d/01-nodoc

        sudo apt-get update -y

        # install minimal dependencies including venv
        sudo apt-get install -y --no-install-recommends \
          ansible \
          python3.12-venv \
          python3-lib2to3
        
        ansible --version

    - name: Install Ansible roles
      run: ansible-galaxy install -r requirements.yml -p roles/

    - name: Run Ansible playbook to install Galaxy
      run: |
        sudo apt-get -qq --purge remove nginx* || true
        ansible-playbook --extra-vars RUNNER_ALLOW_RUNASROOT="1" \
                         -e ansible_user="runner" \
                         -e allow_world_readable_tmpfiles="true" \
                         --skip-tags galaxy_build_client \
                         playbook.yml

    - name: Run complete diagnostics before API wait
      run: |
        echo "--- Nginx Status ---"
        sudo systemctl status nginx.service --no-pager || echo "Nginx status failed"
        
        echo "--- Nginx Error Log (Last 50 lines) ---"
        sudo tail -n 50 /var/log/nginx/error.log || echo "Could not read Nginx error log"

        echo "--- [IMPORTANT] Gunicorn Service Status ---"
        # C'est ici qu'on verra s'il a planté
        sudo systemctl status galaxy-gunicorn.service --no-pager || echo "Gunicorn service status FAILED"
        
        echo "--- [MOST IMPORTANT] Gunicorn Logs (JournalCTL) ---"
        # C'est ici qu'on verra l'erreur Python/Gunicorn
        sudo journalctl -u galaxy-gunicorn.service -n 50 --no-pager || echo "Could not get Gunicorn journal"
        
        echo "--- [CORRECT PATH] Permissions Check: /home/galaxy ---"
        sudo ls -ld /home/galaxy
        
        echo "--- [CORRECT PATH] Permissions Check: /home/galaxy/galaxy ---"
        sudo ls -ld /home/galaxy/galaxy || echo "Directory /home/galaxy/galaxy not found"

        echo "--- [CORRECT PATH] Permissions Check: /home/galaxy/galaxy/config ---"
        sudo ls -ld /home/galaxy/galaxy/config || echo "Directory /home/galaxy/galaxy/config not found"

        echo "--- [CORRECT PATH] Permissions Check: Socket File ---"
        # C'est la vérification finale
        sudo ls -l /home/galaxy/galaxy/config/gunicorn.sock || echo "Socket file not found"
        
      continue-on-error: true

    - name: Wait for API
      run: |
        echo "--- Waiting for Galaxy API to be available ---"
        timeout 180s bash -c 'until curl --fail -s http://127.0.0.1/api/version > /dev/null; do echo -n "." && sleep 5; done'
        echo "Galaxy is up!"
        sudo galaxyctl status

    - name: Run Ansible playbook to install Galaxy tools
      run: ansible-playbook --extra-vars RUNNER_ALLOW_RUNASROOT="1" -e ansible_user="runner" install_tools.yml

    - name: Create virtual environment for Bioblend tests
      run: |
        python3 -m venv venv
        source venv/bin/activate
        pip install --upgrade pip
        pip install -r requirements.txt
        pip show bioblend pytest

    - name: Run Bioblend tests
      run: |
        source venv/bin/activate
        export BIOBLEND_GALAXY_API_KEY=$(cat ./apikey.txt)
        python -m pytest -v --color=yes \
          -k "TestGalaxyHistories or TestGalaxyTools" \
          $(python -c "import bioblend, os; print(os.path.dirname(bioblend.__file__) + '/_tests')")

