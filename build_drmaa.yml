---
# build_drmaa.yml â€” install slurm-drmaa from pre-generated tarball
# Compatible with Ubuntu 24.04 + Slurm 23.11+
# Maintainer: Christophe Antoniewski / ARTbio
# Updated: 2025-10-24

- name: Get current Slurm version
  command: sinfo --version
  register: slurm_version
  changed_when: false

- name: Detect currently linked libslurm in DRMAA (if any)
  shell: |
    if [ -f /usr/lib/libdrmaa.so ]; then
      ldd /usr/lib/libdrmaa.so | grep libslurm | awk '{print $1" "$3}'
    else
      echo "MISSING"
    fi
  register: drmaa_linkage
  changed_when: false

- name: Decide whether rebuild is required
  set_fact:
    drmaa_rebuild: "{{ (drmaa_linkage.stdout is search('MISSING')) or
                      (drmaa_linkage.stdout is not search(slurm_version.stdout | regex_replace('^.*slurm-wlm ', ''))) }}"
  changed_when: false

- debug:
    msg: >
      ðŸ§© Slurm version: {{ slurm_version.stdout }},
      DRMAA linkage: {{ drmaa_linkage.stdout | default('none') }},
      rebuild needed: {{ drmaa_rebuild }}

######################################################################
# Install slurm-drmaa from pre-generated release tarball
######################################################################

- name: Install build dependencies (only if rebuild needed)
  apt:
    name:
      - build-essential
      - libslurm-dev
      - pkg-config
      - wget
    state: present
    update_cache: yes
  when: drmaa_rebuild

- name: Download pre-generated release tarball
  get_url:
    url: https://github.com/natefoo/slurm-drmaa/releases/download/1.1.3/slurm-drmaa-1.1.3.tar.gz
    dest: /usr/local/src/slurm-drmaa-1.1.3.tar.gz
    mode: '0644'
  when: drmaa_rebuild

- name: Extract and compile slurm-drmaa
  shell: |
    cd /usr/local/src
    rm -rf slurm-drmaa-1.1.3
    tar xzf slurm-drmaa-1.1.3.tar.gz
    cd slurm-drmaa-1.1.3
    ./configure --prefix=/usr
    make -j"$(nproc)"
    make install
  args:
    creates: /usr/lib/libdrmaa.so
  when: drmaa_rebuild
  environment:
    CFLAGS: "-O2"
    LDFLAGS: "-Wl,-rpath=/usr/lib/x86_64-linux-gnu"

######################################################################
# Post-install verification
######################################################################

- name: Verify libdrmaa linkage
  shell: ldd /usr/lib/libdrmaa.so | grep slurm || true
  register: drmaa_check
  changed_when: false

- debug:
    msg: >
      âœ… DRMAA installation verified.
      Linked to: {{ drmaa_check.stdout | default('not found') }}
