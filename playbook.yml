---
# Instal Galaxy + Slurm + DRMAA (Ubuntu â‰¥22.04)
# Use Natefoo PPA for slurm-drmaa

- name: Install PostgreSQL objects
  hosts: dbservers
  become: true
  become_user: root

  roles:
    - galaxyproject.postgresql
    - role: galaxyproject.postgresql_objects
      become: true
      become_user: postgres

- name: Install/Expand Galaxy
  hosts: all
  become: true
  become_user: root

  pre_tasks:

    - name: Add official Slurm-DRMAA PPA (Natefoo)
      ansible.builtin.apt_repository:
        repo: ppa:natefoo/slurm-drmaa
        state: present
        update_cache: true

    - name: Install Slurm-DRMAA from the correct PPA release
      ansible.builtin.apt:
        name: slurm-drmaa1
        state: present
        default_release: '{{ ansible_distribution_release }}'
        update_cache: true

    - name: Install required packages
      ansible.builtin.package:
        name:
          - bzip2
          - git
          - make
          - tar
          - python3-venv
          - python3-lib2to3
          - slurm-wlm
        state: present

    - name: Ensure munge runtime dir exists
      ansible.builtin.file:
        path: /run/munge
        owner: munge
        group: munge
        mode: '0755'
        state: directory

    - name: "FIX: Clean out existing Node.js binaries from the venv to avoid nodeenv errors during Galaxy upgrade"
      file:
        path: "/home/galaxy/galaxy/.venv/{{ item }}"
        state: absent
      loop:
        - "lib/node_modules"
        - "bin/node"
        - "bin/npm"
        - "bin/npx"
        - "bin/corepack"
      tags:
        - galaxy_upgrade_fix

    - name: Merge common and specific Galaxy configurations
      ansible.builtin.set_fact:
        galaxy_config: "{{ common_galaxy_config | ansible.builtin.combine(galaxy_config, recursive=true) }}"

  roles:
    - galaxyproject.galaxy
    - role: galaxyproject.miniconda
      become: true
      become_user: "{{ galaxy_user.name }}"
      environment:
        HOME: "/home/galaxy"
        XDG_CONFIG_HOME: "/home/galaxy/.config"
      vars:
        ansible_become_user: galaxy
      tags: [miniconda]
    - galaxyproject.nginx
    - role: galaxyproject.slurm
      become: true
      when: install_slurm
    - role: installUptime
      when: install_uptime


  post_tasks:

    - name: Overwrite nginx.conf
      ansible.builtin.template:
        src: "{{ inventory_dir }}/templates/nginx/nginx.conf.j2"
        dest: /etc/nginx/nginx.conf
        owner: root
        group: root
        mode: '0644'
      notify: Restart nginx

    - name: Create and start Galaxy systemd units via galaxyctl
      ansible.builtin.command:
        cmd: galaxyctl restart
      become: true
      changed_when: true

    - name: Ensure Galaxy is restarted and enabled (for reboot persistence)
      ansible.builtin.systemd:
        name: galaxy.target
        state: restarted
        enabled: true
